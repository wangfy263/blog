---
title: 可视化编辑系统实践
date: 2018-05-29 18:42:19
tags:
---
这篇我想写写可视化编辑系统的实践，重点在数据模型，静态化，工作流，预览等一系列系统功能的实践上，具体的可视化编辑功能，将另开一贴来介绍；

背景
---
前端工程中，有一些页面涉及运营位，根据市场的变化以及运营的要求，需要频繁的更迭，开发人员需要频繁的修改上线；由于生产环境的安全限制，手动上线费时费力，还需要走更多的流程（打申请，写文档，等审批），占用了大量的时间确不能产生多少价值；

CMS
---
传统的解决方案就是采用内容管理平台，运营人员通过CMS来修改，发布内容，包括文字，图片，表格等等一切想要发布的信息；CMS系统把数据和模板结合起来，静态化生成HTML页面或代码块，通过ftp协议上传到前端应用中，供项目使用；

CMS解决了2个问题：
1、没有技术门槛，运营人员可通过界面操作来修改运营位内容；
2、不需要手动上线，ftp一键上传；也省去了复杂的上线流程；

使用CMS系统，解放了开发人员一部分时间，迭代效率提升不少；

CMS系统已经向前迈了一大步，但仍存在不少问题：
1、比较笨重，有一定的门槛，需要有一个熟练的操作人员；
2、CMS一般有复杂的数据结构，需要把每一个图片，文字都对应到一个数据库字段中；维护相对困难；
3、有一些抽象概念（栏目、内容...）；推广困难（用户有意向主动使用，但培训了多次，效果不佳，一直没有交出去）
4、模板复用率低，一旦有结构型的变化，需要开发人员修改模板；


为了能更方便的进行页面的编辑发布，可视化编辑的方案被提上日志

设计思路
---
最初的想法是复用CMS的数据结构，静态化的部分也可以复用；但这么做需要先把CMS的数据模型梳理出来，并且CMS本身不是前后端分离的架构，接口层需要重新开发；这样rest层需要针对不同的前端场景提供各种接口，多表关联的处理太多，rest层的开发将会非常复杂；还有，本次可视化的要求除了，编辑文字图片外，还要有“楼层”（首页的瀑布式结构）的处理（增加，删除，排序）甚至有“楼中楼”的情况，CMS的数据模型难以表达出楼层概念；

如果把每一个页面元素都和数据库对应起来的话，整个系统会显得非常笨重，耦合度非常高，难以扩展，前端和后端的都不灵活；因此我们考虑，数据库只存储必要的信息，不记录所有的前端元素，只记录编辑完成的结果；

前端编辑过程不和后端交互，编辑结束后，将最终的html代码段存储在数据库中，后端根据代码段来静态化生成页面，这样编辑的过程完全有前端工程去处理，这样更灵活也更轻量；

但是这样做有一个难点：当下一次来编辑时，需要依据html代码块还原成可编辑的模板；之前保存在数据库中的是html代码的字符串，要把它还原成可编辑的模板，非常麻烦；

为此，我们将可编辑的数据以一个json对象的形式存储在数据库中，下一次编辑时，前端通过json数据，结合VUE组件，渲染出可编辑界面；

###具体的过程如下：
1、管理员访问后台编辑系统时，首先从数据库中查询出默认的json串，这个json串是初始化系统时录入的；前端根据json串，还原出可编辑界面；
2、管理员操作可编辑界面，前端记录修改，在保存时，把json串和html代码块一起存储在数据库中；
3、后端根据html代码块生成页面，并推送到前端工程使用；

前端处理json数据，并实现可视化操作，仍需要进行大量的处理，这块的细节可以查看lihao的帖子：
xxxxxxxxxxxxxx

最后决定，除了记录一些页面的固有信息，只存储json数据和html代码块，json用作还原可视化编辑界面，html代码块用来静态化生成页面；

数据模型：
---
```bash
  id    主键  ,
  name   生成页名称  ,
  area_code    地市  ,
  type   类型 1:首页 2:地市专项  ,
  json   json数据  ,
  code   html代码块  ,
  create_time   创建时间  ,
  update_time   更新时间  ,
  update_login_no   更新操作工号  ,
  status   状态(0：编辑完成，1：审批中，2：审批完成，-1：被打回，9：生效，-9：失效)  ,
  channels   发布渠道  ,
  access_url 静态化页面路径,
  remark1   备用字段1  ,
  remark2   备用字段2  ,
```

工作流
---
根据用户的要求，可视化操作需要有审批流程，具体的审批流程是：
1、地市发布人员--地市审批人员--省公司审批人员
2、省公司发布人员--省公司审批人员
并且，不同地市间，审批人员和发布人员不能交叉：
![审批关系图](approvalProcess.jpg)

工作流系统采用，Activity工作流系统

其中工作流角色，采用基础域中的角色数据模型，分别定义四个角色，地市发布人员，地市审批人员，省公司审批人员和省公司审批人员；

工作流对接到后台系统中，出现很多特殊的情况：
1、不同地市的审批如何避免交叉？
2、部分VIP工号要求既有发布权限，又有审批角色，当一个工号存在与统一审批流程中的多个角色中时，如何处理？
3、当某个工号同时在多个工作流的角色中时，如何避免在指定下一步审批人时，不会把其他工作流的审批人也展示出来？

解决这些问题的思路，可以看一下fengchao的帖子：
xxxxxxxxxxxxxxxxx

我这里说一下前端的设计；
前端跟工作流相关的有两个模块，一个是发布管理，一个是审批管理
发布管理包含6个状态，
1、待审批（完成可视化编辑，但未点击“发起审批”，此状态时仍可以修改配置信息）
2、审批中（即等待审批的配置信息，提供审批提醒功能）
3、被打回 审批不通过的配置信息）
4、审批完成（审批通过的配置信息，运营人员可点击“发布”按钮，正式发布）
5、已上线（审批通过后，在待发布列表点击发布按钮后，状态变更为已上线）
6、已结束（到达活动结束时间或者手动点击“结束活动”的配置信息。此状态下提供“下线”按钮）

对应在数据库的state   0：编辑完成，1：审批中，2：审批完成，-1：被打回，9：生效，-9：失效

不同的status，对应着不同的操作，这里是由前端自己来管理，如下图：
![发布管理](issue.jpg)

审批管理：
只有在状态为1（审批中）时，这条记录会出现在审批管理中；
审批管理提供，预览、打回、通过三个状态，如下图：
![审批管理](approval.jpg)

可以看到，审批管理和发布管理涉及的可操作按钮有：`预览`，`编辑`，`发起审批`，`打回`，`通过`，`发布`，`活动下线`
除了预览和编辑，其它操作都会改变status；

预览
---
可视化编辑后，操作人员如何确认自己修改是否生效？审批人员依据什么来确认发布人员的操作是否正确？预览的功能必不可少；

一般预览的思路是静态化后打开页面查看效果，但是本次可视化系统，编辑后并非完整的页面，只是一段代码块，那么预览就必须要依赖于前端工程；为了预览重新搭建一个前端工程显然不值得，那么灰度环境是个非常好的选择；

但是前端工程是根据手机号来进行灰度的，如果发布人员和审批人员的手机号不在配置列表中，就无法访问灰度环境；

因此，在灰度管理平台中增加了一个默认的号码，当cookie中存在该号码时，将被代理至灰度环境；

###二维码
预览链接通过二维码的方式显示出来，发布人员和审批人员只需要扫描二维码即可预览编辑后的界面；
审批管理中的预览：
![预览](preview.jpg)

保存成功后，同样会弹出二维码，提示预览测试：
![预览](preview2.jpg)

有了预览功能，整个工作流就可以形成完整的闭环；
![工作流](workflow.png)


图片资源管理
---
在营销活动的可视化编辑中，图片可以上传也可以选择已经上传好的，因此需要图片管理功能；

图片分了几个维度：
1、分公共图片库，以及地市图片库，地市运营人员可以使用本地市图片库，以及公共图片库；但不能使用其它地市图片库；省公司运营只维护公共图片库；
2、按照可视化控件分类，轮播图控件，背景控件的图片功能不同在选择时不能交叉；
3、按照图片比例管理，即使是同一种控件，有时图片尺寸比例也不相同；在选择时也需要按照比例来控制；

图片资源记录：
```bash
  material_id  素材ID,
  area_code    地区编码,
  material_url 素材路径,
  control_id   控件ID,
  ratio        长宽比,
  remark1      备用字段1,
  remark2      备用字段2,
```

图片管理接口：
1、按照归属地查询

工作流、预览，资源库管理、ftp推送、静态化

